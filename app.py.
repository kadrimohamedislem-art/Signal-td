# app.py ‚Äî Professional Gradio Signals (XAU/USD & WTI/USD) ‚Äî 30min
import os
import gradio as gr
import requests
import pandas as pd
import pandas_ta as ta
import plotly.graph_objects as go
from datetime import datetime, timezone

# ---------- CONFIG ----------
API_KEY = os.getenv("506f0859dc0f4ff6b30b29d800551be2")
if not API_KEY:
    raise ValueError("506f0859dc0f4ff6b30b29d800551be2")

BASE_URL = "https://api.twelvedata.com/time_series"
SYMBOLS = {"Gold": "XAU/USD", "Oil": "WTI/USD"}
TIMEFRAME = "30min"
CANDLES = 200

DEFAULT_TP1 = 20.0
DEFAULT_TP2 = 40.0
DEFAULT_TP3 = 60.0
DEFAULT_SL  = 25.0

# ---------- DATA FETCH ----------
def fetch_ohlc(symbol):
    params = {
        "symbol": symbol,
        "interval": TIMEFRAME,
        "outputsize": CANDLES,
        "apikey": API_KEY
    }
    r = requests.get(BASE_URL, params=params, timeout=10)
    data = r.json()
    if "values" not in data:
        return None
    df = pd.DataFrame(data["values"])
    df = df[['datetime','open','high','low','close']]
    df.columns = ['timestamp','open','high','low','close']
    df = df.astype(float)
    df['timestamp'] = pd.to_datetime(df['timestamp'])
    return df.iloc[::-1].reset_index(drop=True)

# ---------- INDICATORS ----------
def prepare_indicators(df):
    df = df.copy()
    df['ema9'] = ta.ema(df['close'], length=9)
    df['ema21'] = ta.ema(df['close'], length=21)
    df['rsi'] = ta.rsi(df['close'], length=14)
    return df

def compute_strength(df):
    last = df.iloc[-1]
    score = 0
    score += 30 if last['ema9'] > last['ema21'] else 10
    score += 30 if last['rsi'] < 30 or last['rsi'] > 70 else 20
    gap = abs(last['ema9'] - last['ema21']) / last['close']
    score += min(gap * 1000, 40)
    return round(min(score, 100), 1)

def generate_signal(df, tp1, tp2, tp3, sl):
    df = prepare_indicators(df)
    last, prev = df.iloc[-1], df.iloc[-2]
    direction = "NEUTRAL"
    reasons = []

    if prev['ema9'] <= prev['ema21'] and last['ema9'] > last['ema21']:
        direction = "BUY"
        reasons.append("EMA9 crossed above EMA21")
    elif prev['ema9'] >= prev['ema21'] and last['ema9'] < last['ema21']:
        direction = "SELL"
        reasons.append("EMA9 crossed below EMA21")

    if last['rsi'] < 30:
        reasons.append("RSI oversold")
        if direction == "NEUTRAL":
            direction = "BUY"
    elif last['rsi'] > 70:
        reasons.append("RSI overbought")
        if direction == "NEUTRAL":
            direction = "SELL"

    entry = last['close']
    if direction == "BUY":
        slv = entry - sl
        tp = [entry + tp1, entry + tp2, entry + tp3]
    elif direction == "SELL":
        slv = entry + sl
        tp = [entry - tp1, entry - tp2, entry - tp3]
    else:
        slv, tp = None, [None]*3

    return direction, entry, slv, tp, reasons, compute_strength(df), last['rsi']

# ---------- UI ----------
with gr.Blocks(title="Gold & Oil Signals") as demo:
    gr.Markdown("## üìà Gold (XAU/USD) & Oil (WTI/USD) Signals ‚Äî 30min")

    tp1 = gr.Number(DEFAULT_TP1, label="TP1")
    tp2 = gr.Number(DEFAULT_TP2, label="TP2")
    tp3 = gr.Number(DEFAULT_TP3, label="TP3")
    sl  = gr.Number(DEFAULT_SL,  label="SL")

    auto = gr.Checkbox(label="Auto refresh (30 min)", value=False)
    btn = gr.Button("Refresh")

    gold_out = gr.Markdown()
    oil_out = gr.Markdown()

    def update(tp1, tp2, tp3, sl, auto):
        text = ""
        for name, symbol in SYMBOLS.items():
            df = fetch_ohlc(symbol)
            if df is None:
                text += f"‚ùå {name}: data error\n\n"
                continue
            d, e, s, t, r, strength, rsi = generate_signal(df, tp1, tp2, tp3, sl)
            text += f"""
### {name}
**Signal:** {d}  
**Entry:** {round(e,2)}  
**SL:** {round(s,2) if s else '-'}  
**TP:** {', '.join(str(round(x,2)) for x in t if x)}  
**Strength:** {strength}/100  
**RSI:** {round(rsi,1)}  
---
"""
        return text, text

    btn.click(update, [tp1,tp2,tp3,sl,auto], [gold_out, oil_out])

    gr.Timer(1800, active=auto).tick(
        update,
        [tp1,tp2,tp3,sl,auto],
        [gold_out, oil_out]
    )

demo.launch()
